<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Changer le mot de passe</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudTextField 
                @bind-Value="_oldPassword"
                Label="Mot de passe actuel"
                Variant="Variant.Outlined"
                InputType="@(_showOldPassword ? InputType.Text : InputType.Password)"
                Adornment="Adornment.End"
                AdornmentIcon="@(_showOldPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                OnAdornmentClick="@(() => _showOldPassword = !_showOldPassword)"
                Required="true"
                RequiredError="Le mot de passe actuel est requis"
                Class="mt-2" />
            
            <MudTextField 
                @bind-Value="_newPassword"
                Label="Nouveau mot de passe"
                Variant="Variant.Outlined"
                InputType="@(_showNewPassword ? InputType.Text : InputType.Password)"
                Adornment="Adornment.End"
                AdornmentIcon="@(_showNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                OnAdornmentClick="@(() => _showNewPassword = !_showNewPassword)"
                Required="true"
                RequiredError="Le nouveau mot de passe est requis"
                Validation="@(new Func<string, string?>(ValidateNewPassword))"
                Immediate="true"
                Class="mt-4" />
            
            <MudTextField 
                @bind-Value="_confirmPassword"
                Label="Confirmer le mot de passe"
                Variant="Variant.Outlined"
                InputType="@(_showConfirmPassword ? InputType.Text : InputType.Password)"
                Adornment="Adornment.End"
                AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                OnAdornmentClick="@(() => _showConfirmPassword = !_showConfirmPassword)"
                Required="true"
                RequiredError="Veuillez confirmer le mot de passe"
                Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                Immediate="true"
                Class="mt-4" />
        </MudForm>
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Annuler</MudButton>
        <MudButton 
            Color="Color.Primary" 
            Variant="Variant.Filled"
            OnClick="Submit"
            Disabled="@(!_isValid || _isSubmitting)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Modification...</MudText>
            }
            else
            {
                <MudText>Modifier</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Inject]
    private IAuthService AuthService { get; set; } = null!;

    private MudForm _form = null!;
    private bool _isValid;
    private bool _isSubmitting;
    private string _oldPassword = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private bool _showOldPassword;
    private bool _showNewPassword;
    private bool _showConfirmPassword;
    private string? _errorMessage;

    private string? ValidateNewPassword(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "Le nouveau mot de passe est requis";
        
        if (value.Length < 6)
            return "Le mot de passe doit contenir au moins 6 caractères";
        
        return null;
    }

    private string? ValidateConfirmPassword(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "Veuillez confirmer le mot de passe";
        
        if (value != _newPassword)
            return "Les mots de passe ne correspondent pas";
        
        return null;
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        await _form.Validate();
        
        if (!_isValid)
            return;

        _isSubmitting = true;
        _errorMessage = null;
        StateHasChanged();

        var success = await AuthService.ChangePasswordAsync(_oldPassword, _newPassword);
        
        if (success)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            _errorMessage = "Échec de la modification du mot de passe. Vérifiez votre mot de passe actuel.";
            _isSubmitting = false;
            StateHasChanged();
        }
    }
}
