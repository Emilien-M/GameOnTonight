@page "/library"
@inject IBoardGamesService BoardGamesService
@inject IGroupContextService GroupContext
@inject NavigationManager Navigation
@inject IErrorService ErrorService
@inject IDialogService DialogService
@using GameOnTonight.RestClient.Models
@using GameOnTonight.App.Components.Groups
@implements IDisposable

<PageTitle>Ma Ludothèque</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h3">Ma Ludothèque</MudText>
        <MudText Typo="Typo.body2" Class="mud-text-secondary">
            @GetSubtitle()
        </MudText>
    </div>
    <div>
        <GroupFilterSelector OnFilterChanged="OnFilterChangedAsync" />
    </div>
</div>

<div class="mb-3 d-flex align-center gap-3">
    <MudTextField @bind-Value="searchText" Variant="Variant.Outlined" Label="Rechercher un jeu..." AdornmentIcon="@Icons.Material.Filled.Search" Adornment="Adornment.Start" Class="flex-grow-1"></MudTextField>
    <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" OnClick="@(() => CreateNew())"></MudFab>
</div>

@if (isLoading)
{
    <div>Chargement…</div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
}
else if (games.Count == 0)
{
    <MudAlert Severity="Severity.Info">Votre ludothèque est vide. Ajoutez votre premier jeu !</MudAlert>
} 
else
{
    <MudStack>
        
        <Virtualize Items="games" Context="game">
            <MudCard>
                <MudCardContent>
                    <div class="d-flex flex-row justify-space-between align-items-center">
                        <div>
                            <div class="d-flex align-center gap-2 mb-2">
                                <MudText Typo="Typo.h5">@game.Name</MudText>
                                @if (game.GroupId != null && !string.IsNullOrEmpty(game.GroupName))
                                {
                                    <MudChip T="string" Size="Size.Small">@game.GroupName</MudChip>
                                }
                            </div>
                            <div>
                                <MudChip T="string">
                                    @game.MinPlayers - @game.MaxPlayers joueurs
                                </MudChip>
                                <MudChip T="string">@game.DurationMinutes min</MudChip>
                                @if (game.GameTypes != null)
                                {
                                    @foreach (var gameType in game.GameTypes)
                                    {
                                        <MudChip T="string">@gameType</MudChip>
                                    }
                                }
                            </div>
                            @if (game.GroupId != null)
                            {
                                <MudText Typo="Typo.subtitle2">
                                    <div class="d-flex align-center gap-1">
                                        <LucideIcon Name="user"></LucideIcon>
                                        @if (game.IsOwner == true)
                                        {
                                            <span>Propriétaire</span>
                                        }
                                        else
                                        {
                                            <span>Partagé</span>
                                        }
                                    </div>
                                </MudText>
                            }
                            
                        </div>
                        <div class="d-flex gap-2 flex-shrink-0">
                            <MudIconButton Color="Color.Secondary" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => Edit(game.Id))"></MudIconButton>
                            <MudIconButton Color="Color.Warning" Icon="@Icons.Material.Filled.Delete" OnClick="@(() => ConfirmDeleteAsync(game))"></MudIconButton>
                        </div>
                    </div>
                </MudCardContent>
            </MudCard>
        </Virtualize>
        
    </MudStack>
}

@code {
    private List<BoardGameViewModel> games = new();
    private bool isLoading;
    private string? errorMessage;
    private string searchText = string.Empty;
    private int? _selectedGroupId;

    protected override async Task OnInitializedAsync()
    {
        // Synchroniser avec le contexte global
        _selectedGroupId = GroupContext.SelectedGroupId;
        
        // S'abonner aux changements
        GroupContext.OnFilterChanged += OnFilterChanged;
        
        await LoadAsync();
    }

    private void OnFilterChanged()
    {
        _selectedGroupId = GroupContext.SelectedGroupId;
        InvokeAsync(async () =>
        {
            await LoadAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        GroupContext.OnFilterChanged -= OnFilterChanged;
    }

    private async Task LoadAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            var items = await BoardGamesService.GetAllAsync(_selectedGroupId);
            games = items.ToList();
        }
        catch (OperationCanceledException)
        {
            // Navigation or manual cancellation: ignore to avoid UI error noise
        }
        catch (Exception ex)
        {
            errorMessage = ErrorService.GetErrorMessage(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnFilterChangedAsync((GroupFilterMode Mode, int? GroupId, string? GroupName) filter)
    {
        _selectedGroupId = filter.GroupId;
        await LoadAsync();
    }

    private string GetSubtitle()
    {
        var count = games.Count;
        return _selectedGroupId switch
        {
            null => $"Tous les jeux ({count} jeux)",
            0 => $"Mes jeux personnels ({count} jeux)",
            _ => $"Jeux du groupe sélectionné ({count} jeux)"
        };
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/library/new");
    }

    private void Edit(int? id)
    {
        if (id.HasValue)
        {
            Navigation.NavigateTo($"/library/edit/{id.Value}");
        }
    }

    private async Task DeleteAsync(int? id)
    {
        if (!id.HasValue) return;
        try
        {
            await BoardGamesService.DeleteAsync(id.Value);
            await LoadAsync();
        }
        catch (OperationCanceledException)
        {
            // Ignore cancellation on navigation or manual cancel
        }
        catch (Exception ex)
        {
            errorMessage = ErrorService.GetErrorMessage(ex);
        }
    }

    private async Task ConfirmDeleteAsync(BoardGameViewModel game)
    {
        var gameId = game.Id;
        if (gameId is null) return;

        var parameters = new DialogParameters<ConfirmDeleteDialog>
        {
            { x => x.GameName, game.Name ?? "ce jeu" }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ConfirmDeleteDialog>("Confirmer la suppression", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await DeleteAsync(gameId);
        }
    }
}
