@page "/library/new"
@page "/library/edit/{Id:int}"

<PageTitle>@(IsEdit ? "Modifier un jeu" : "Ajouter un jeu")</PageTitle>

<MudText Typo="Typo.h3" Class="pb-3">@(IsEdit ? "Modifier un jeu" : "Ajouter un jeu")</MudText>

<EditForm EditContext="_editContext" OnValidSubmit="OnSubmitAsync">
    <DataAnnotationsValidator />

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
    }

    <div class="d-flex flex-column gap-4">
        <MudTextField @bind-Value="form.Name" 
                      Label="Nom du jeu" 
                      Variant="Variant.Outlined" 
                      Required="true"
                      For="@(() => form.Name)" />
        
        <div class="d-flex gap-4">
            <MudNumericField @bind-Value="form.MinPlayers" 
                             Label="Joueurs min" 
                             Min="1" 
                             Variant="Variant.Outlined" 
                             Class="flex-1"
                             For="@(() => form.MinPlayers)" />
            <MudNumericField @bind-Value="form.MaxPlayers" 
                             Label="Joueurs max" 
                             Min="1" 
                             Variant="Variant.Outlined" 
                             Class="flex-1"
                             For="@(() => form.MaxPlayers)" />
        </div>
        
        <MudNumericField @bind-Value="form.DurationMinutes" 
                         Label="Durée (minutes)" 
                         Min="1" 
                         Variant="Variant.Outlined"
                         For="@(() => form.DurationMinutes)" />
        
        <div>
            <MudText Typo="Typo.body2" Class="mb-2">Types / Catégories</MudText>
            <div class="d-flex flex-wrap gap-2 mb-2">
                @foreach (var gameType in form.GameTypes)
                {
                    <MudChip T="string" 
                             Color="Color.Primary" 
                             OnClose="@(() => RemoveGameType(gameType))">
                        @gameType
                    </MudChip>
                }
            </div>
            <div class="d-flex gap-2 align-start">
                <MudTextField T="string" 
                              @bind-Value="_newGameType"
                              Label="Ajouter un type" 
                              Variant="Variant.Outlined"
                              HelperText="Saisissez un nouveau type ou sélectionnez ci-dessous"
                              OnKeyUp="OnGameTypeKeyUp"
                              Style="flex: 1;" />
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="AddGameType"
                           Disabled="@string.IsNullOrWhiteSpace(_newGameType)"
                           Class="mt-2"
                           Style="height: 56px;">
                    Ajouter
                </MudButton>
            </div>
            @if (_filteredGameTypes.Any())
            {
                <div class="d-flex flex-wrap gap-1 mt-2">
                    <MudText Typo="Typo.caption" Class="mr-2">Suggestions :</MudText>
                    @foreach (var suggestion in _filteredGameTypes.Take(5))
                    {
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => SelectGameType(suggestion))">
                            @suggestion
                        </MudChip>
                    }
                </div>
            }
        </div>

        <div class="d-flex gap-2 mt-4">
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Disabled="@isSubmitting">
                @(isSubmitting ? "Enregistrement…" : "Enregistrer")
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel">
                Annuler
            </MudButton>
        </div>
    </div>
</EditForm>
